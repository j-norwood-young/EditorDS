<!DOCTYPE html>
<meta charset="UTF-8" lang="en-gb">
<script src='http://code.jquery.com/jquery-1.7.2.min.js'></script>
<script language='javascript' type='text/javascript'>
(function( $ ) {
	$.fn.editorDS = function() {
		this.margin = {x: 10, y: 10};
		this.width = 900;
		this.height = 300;
		this.fontsize = 24;
		this.text = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam vestibulum sodales lacus, id sollicitudin mi adipiscing id. Morbi purus felis, iaculis nec sagittis id, ultrices ac sapien. Praesent velit dolor, consectetur iaculis scelerisque eget, cursus nec magna. Fusce vitae turpis est, at luctus leo. Vestibulum purus nisi, suscipit sed accumsan ut, blandit vel quam. Vivamus at dui a felis molestie adipiscing ac quis leo. Aliquam erat volutpat. Vestibulum porta, augue eget malesuada auctor, urna mauris hendrerit urna, et accumsan massa enim bibendum leo. Etiam et congue elit. Pellentesque a nibh justo, at dignissim risus. Mauris non neque a mi accumsan mattis. Integer tortor nisi, consequat sagittis dignissim ac, hendrerit eget ipsum. Proin leo augue, viverra vitae condimentum eu, pretium id erat.";
		this.el = false;
		this.append('<canvas class="editorDS-canvas" width="'+this.width+'" height="'+this.height+'"></canvas>');
		var canvas = this.children('.editorDS-canvas')[0];
		var context = canvas.getContext('2d');
		var cursorpos={ x:this.margin.x, y:this.margin.y };
		var textcursorpos=0;
		var linecursorpos={x:0, y:0}; //Char, line
		var self = this;
		var lines=[];
		context.font = this.fontsize+"px helvetica";
		
		$(document).keypress(function(e) {
			var caught = false;
			var keyCode=e.which;
			letter='';
			if (!e.metaKey) {
				var letter=String.fromCharCode(e.keyCode);
				self.text = self.text.substring(0, textcursorpos) + letter + self.text.substring(textcursorpos, self.text.length);
				self.change_textcursor(+1);
				caught = true;
			}
			if (caught) {
				return false;
			}
		});
		
		$(document).keydown(function(e) {
			//console.log(e);
			var caught = false;
			var keyCode=e.which;
			if (keyCode == 8) { //backspace
				self.text = self.text.substring(0, textcursorpos - 1) + self.text.substring(textcursorpos, self.text.length);
				self.change_textcursor(-1);
				caught = true;
			}
			if (keyCode == 37) { //left arrow
				if (e.metaKey) {
					self.set_linecursorpos(0, linecursorpos.y);
				} else if (textcursorpos > 0) {
					self.change_textcursor(-1);
				}
				caught = true;
			}
			if (keyCode == 39) { //right arrow
				if (e.metaKey) {
					self.set_linecursor(lines[linecursorpos.y].length-1, linecursorpos.y);
				} else if (textcursorpos< self.text.length) {
					self.change_textcursor(+1);
				}
				caught = true;
			}
			if (keyCode == 38) { //up arrow
				if ((lines.length>1) && (linecursorpos.y>0)) {
					self.change_linecursor(0, -1);
				}
				caught = true;
			}
			if (keyCode == 40) { //down arrow
				if (linecursorpos.y<(lines.length-1)) {
					self.change_linecursor(0, 1);
				}
				caught = true;
			}
			if (caught) {
				return false;
			}
		});
		
		$('.editorDS-canvas').click(function(e) {
			x=e.offsetX;
			y=e.offsetY;
			$("#mousex").html(x);
			$("#mousey").html(y);
			line = Math.floor(y / self.fontsize);
			var s="";
			var char=0;
			for(var i=0; i < lines[line].length; i++) {
				s = s + lines[line][i];
				if (context.measureText(s).width > x) {
					char = s.length - 1;
					break;
				}
			}
			self.set_linecursor(char, line);
		});
		
		//Animation
		var cursorBlink=0;
		setInterval(function() {
			if (cursorBlink) {
				cursorBlink = 0;
			} else {
				cursorBlink=1;
			}
			self.animate();
		}, 500);
		
		//Fill our 'lines' array with words
		this.populate_lines = populate_lines;
		
		function populate_lines() {
			lines=[];
			var tmp = '';
			var words = this.text.split(' ');
			while(words.length) {
			    s = tmp;
			    word = words.shift();
			    tmp.length ? tmp = tmp +' '+ word : tmp = word; //Careful not to put a space on first line
			    var width=context.measureText(tmp).width;
			    if (width >= (this.width - 10)) {
			    	lines.push(s + ' '); //We want to end with a space
			    	tmp = word; //Start next line with the wrapped word
			    }
			}
			lines.push(tmp); //Don't forget the last line
		}
		
		//Change the linecursorpos to conform with the textcursorpos
		this.textpostolinepos = textpostolinepos;
		
		function textpostolinepos() {
			this.populate_lines();
			var tmplines = [];
			var orig = this.text.substring(0, textcursorpos);
			var tmp = '';
			var words = orig.split(' ');
			while(words.length) {
				s = tmp;
				word = words.shift();
				tmp.length ? tmp = tmp +' '+ word : tmp = word; //Careful not to put a space on first line
				var width=context.measureText(tmp).width;
				if (width >= (this.width - 10)) {
					tmplines.push(s);
					tmp = word; //Start next line with the wrapped word
				}
			}
			tmplines.push(tmp); //Don't forget the last line
			linecursorpos.y = tmplines.length - 1;
			//Check that we're not on a wrapped word here
			var tmpline = lines[linecursorpos.y];
			if (tmpline.length - 1 < tmplines[tmplines.length - 1].length) {
				linecursorpos.y++;
				linecursorpos.x = tmplines[tmplines.length - 1].length - tmpline.length;
			} else {
				linecursorpos.x = tmplines[tmplines.length - 1].length;
			}
		}
		
		//Change the textcursorpos to conform with the linecursorpos
		this.linepostotextpos = linepostotextpos;
		
		function linepostotextpos() {
			var count=0;
			for(x=0; x<linecursorpos.y; x++) {
				count=count+lines[x].length;
			}
			textcursorpos=count+linecursorpos.x;
		}
		
		this.change_textcursor = change_textcursor;
		
		function change_textcursor(x) {
			textcursorpos += x;
			this.populate_lines();
			this.textpostolinepos();
			this.animate();
			this.display();
		}
		
		this.set_textcursor = set_textcursor;
		
		function set_textcursor(x) {
			textcursorpos = x;
			this.populate_lines();
			this.textpostolinepos();
			this.animate();
			this.display();
		}
		
		this.change_linecursor = change_linecursor;
		
		function change_linecursor(x, y) {
			linecursorpos.x += x;
			linecursorpos.y += y;
			if (linecursorpos.x > lines[linecursorpos.y].length) {
				linecursorpos.x = lines[linecursorpos.y].length;
			}
			this.populate_lines();
			this.linepostotextpos();
			this.animate();
			this.display();
		}
		
		this.set_linecursor = set_linecursor;
		
		function set_linecursor(x, y) {
			linecursorpos.x = x;
			linecursorpos.y = y;
			this.populate_lines();
			this.linepostotextpos();
			this.animate();
			this.display();
		}
		
		this.display = display;
		
		function display() {
			var self=this;
			$("#linecursorx").html(linecursorpos.x);
			$("#linecursory").html(linecursorpos.y);
			$("#textcursor").html(textcursorpos);
		}
		
		this.animate = function() {
			//Clear the scene
			context.clearRect(0, 0, this.width, this.height);
			
			
			//lines=[];
			//Wrap by word and put cursor in right place
			//this.populate_lines();
			for(x=0; x < lines.length; x++) {
				context.fillText(lines[x], 0, (self.fontsize * (x+1)));
			}
			if (cursorBlink == 1) {
				cursorpos.x = context.measureText(lines[linecursorpos.y].substring(0, linecursorpos.x)).width;
				cursorpos.y = linecursorpos.y * self.fontsize;
				context.fillRect(cursorpos.x, cursorpos.y, 1,  this.fontsize);
			}
		}
		
		this.populate_lines();
		
		this.append('<input type="hidden" class="editorDS-input" />');
	}
})(jQuery);

	$(function() {
		$('#test').editorDS();
	});
	
</script>

<h1>EditorDS</h1>
<h3>An editor that Doesn't Suck</h3>
<div id='test'>
<!--<div style='height: 22px; margin-bottom: 5px; font-family: helvetica; ' id='editorDS-buttons'>
	<div style='float: left; margin-right: 2px; width: 20px; height: 20px; border: 1px #CCC solid; text-align: center; cursor: pointer;' class='editorDS-button bold'>B</div>
	<div style='float: left; margin-right: 2px; width: 20px; height: 20px; border: 1px #CCC solid; text-align: center; cursor: pointer;' class='editorDS-button italic'>i</div>
	<div style='float: left; margin-right: 2px; width: 20px; height: 20px; border: 1px #CCC solid; text-align: center; cursor: pointer;' class='editorDS-button underline'>U</div>
	<div style='float: left; margin-right: 2px; width: 20px; height: 20px; border: 1px #CCC solid; text-align: center; cursor: pointer;' class='editorDS-button pic'>pic</div>
</div>-->
</div>
<div>
	<p><strong>Line cursor pos:</strong> <span id="linecursorx">0</span> <span id="linecursory">0</span></p>
	<p><strong>Text cursor pos</strong> <span id="textcursor">0</span></p>
	<p><strong>Mouse click pos:</strong> <span id="mousex">0</span> <span id="mousey">0</span></p>
</div>
<style>
	.done { text-decoration: line-through }
</style>
<h2>Feature List</h2>
<div id='progress'>
	<ol>
		<li class='done'>Catch typing and write letters on canvas</li>
		<li class='done'>Move cursor with typing</li>
		<li class='done'>Move cursor with arrows forward and backward</li>
		<li class='done'>Delete</li>
		<li class='done'>Wrap lines</li>
		<li class='done'>Move cursor to next and previous lines</li>
		<li class='done'>Move cursor by line with arrows up and down</li>
		<li class='done'>Fix multiline delete</li>
		<li class='done'>Clean up cursor handling</li>
		<li class='done'>Moving cursor with mouse</li>
		<li class='done'>Blinking cursor</li>
		<li>Formatting system</li>
		<li>Bold</li>
		<li>Italic</li>
		<li>Underline</li>
		<li>Strikethrough</li>
		<li>Font sizes</li>
		<li>Hard line breaks</li>
		<li>Soft line breaks</li>
		<li>Images</li>
		<li>Tables</li>
		<li>Copy and pasting</li>
		<li>Selecting</li>
		<li>â€¦</li>
		<li>WIN!</li>
	</ol>
</div>